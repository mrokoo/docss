<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>1 文件系统 | Mrokooの知识库</title>
    <meta name="description" content="mrokoo note ">
    <link rel="stylesheet" href="/note/assets/style.f4ab8da1.css">
    <link rel="modulepreload" href="/note/assets/app.e06fd376.js">
    <link rel="modulepreload" href="/note/assets/Unix_文件的内部表示.md.f025079b.lean.js">
    
    <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance"),a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-c6a644e1><!--[--><!--]--><!--[--><span tabindex="-1" data-v-151f2593></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-151f2593> Skip to content </a><!--]--><!----><header class="VPNav" data-v-c6a644e1 data-v-a71a30f1><div class="VPNavBar has-sidebar" data-v-a71a30f1 data-v-6f1d18b5><div class="container" data-v-6f1d18b5><div class="VPNavBarTitle has-sidebar" data-v-6f1d18b5 data-v-d5925166><a class="title" href="/note/" data-v-d5925166><!--[--><!--]--><!----><!--[-->Mrokooの知识库<!--]--><!--[--><!--]--></a></div><div class="content" data-v-6f1d18b5><!--[--><!--]--><!----><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-6f1d18b5 data-v-f83db6ba><span id="main-nav-aria-label" class="visually-hidden" data-v-f83db6ba>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/note/doc/" data-v-f83db6ba data-v-47a2263e data-v-3c355974><!--[-->文档<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/note/rnote/" data-v-f83db6ba data-v-47a2263e data-v-3c355974><!--[-->笔记<!--]--><!----></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-6f1d18b5 data-v-a3e7452b><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-a3e7452b data-v-1899cd41 data-v-086e8519><span class="check" data-v-086e8519><span class="icon" data-v-086e8519><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-1899cd41><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-1899cd41><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><!----><div class="VPFlyout VPNavBarExtra extra" data-v-6f1d18b5 data-v-e4361c82 data-v-6ffb57d3><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-6ffb57d3><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-6ffb57d3><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-6ffb57d3><div class="VPMenu" data-v-6ffb57d3 data-v-1c5d0cfc><!----><!--[--><!--[--><!----><div class="group" data-v-e4361c82><div class="item appearance" data-v-e4361c82><p class="label" data-v-e4361c82>Appearance</p><div class="appearance-action" data-v-e4361c82><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-e4361c82 data-v-1899cd41 data-v-086e8519><span class="check" data-v-086e8519><span class="icon" data-v-086e8519><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-1899cd41><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-1899cd41><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><!----><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-6f1d18b5 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div><!----></header><div class="VPLocalNav" data-v-c6a644e1 data-v-aac27d5e><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-aac27d5e><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-aac27d5e><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-aac27d5e>Menu</span></button><a class="top-link" href="#" data-v-aac27d5e> Return to top </a></div><aside class="VPSidebar" data-v-c6a644e1 data-v-f332cb62><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-f332cb62><span class="visually-hidden" id="sidebar-aria-label" data-v-f332cb62> Sidebar Navigation </span><!--[--><div class="group" data-v-f332cb62><section class="VPSidebarGroup" data-v-f332cb62 data-v-35f99ef5><div class="title" data-v-35f99ef5><h2 class="title-text" data-v-35f99ef5>Unix程序设计</h2><div class="action" data-v-35f99ef5><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-35f99ef5><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-35f99ef5><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-35f99ef5><!--[--><!--[--><a class="VPLink link link" href="/note/Unix/" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>目录</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/note/Unix/%E6%95%B0%E6%8D%AE%E7%BC%93%E5%86%B2%E5%8C%BA.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>数据缓冲区</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link active" href="/note/Unix/%E6%96%87%E4%BB%B6%E7%9A%84%E5%86%85%E9%83%A8%E8%A1%A8%E7%A4%BA.html" style="padding-left:0px;" data-v-2cfe069a data-v-3c355974><!--[--><span class="link-text" data-v-2cfe069a>文件内部表示</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-c6a644e1 data-v-c95df128><div class="VPDoc has-sidebar has-aside" data-v-c95df128 data-v-37ebe389><div class="container" data-v-37ebe389><div class="aside" data-v-37ebe389><div class="aside-curtain" data-v-37ebe389></div><div class="aside-container" data-v-37ebe389><div class="aside-content" data-v-37ebe389><div class="VPDocAside" data-v-37ebe389 data-v-afc4c1a1><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" data-v-afc4c1a1 data-v-2865c0b0><div class="content" data-v-2865c0b0><div class="outline-marker" data-v-2865c0b0></div><div class="outline-title" data-v-2865c0b0>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-2865c0b0><span class="visually-hidden" id="doc-outline-aria-label" data-v-2865c0b0> Table of Contents for current page </span><ul class="root" data-v-2865c0b0 data-v-1188541a><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-afc4c1a1></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-37ebe389><div class="content-container" data-v-37ebe389><!--[--><!--]--><main class="main" data-v-37ebe389><div style="position:relative;" class="vp-doc _note_Unix_%E6%96%87%E4%BB%B6%E7%9A%84%E5%86%85%E9%83%A8%E8%A1%A8%E7%A4%BA" data-v-37ebe389><div><h1 id="_1-文件系统" tabindex="-1">1 文件系统 <a class="header-anchor" href="#_1-文件系统" aria-hidden="true">#</a></h1><p>内核不直接操作实际的硬盘进行数据访问，而是通过一层抽象——文件系统，与硬盘打交道。因此，文件系统就成为<strong>逻辑设备</strong>（logical device)，文件系统由一系列逻辑块（logical block)构成。 <img src="https://note-image-1302477034.cos.ap-chengdu.myqcloud.com/pic/202210081010056.png" alt=""> 文件系统就是操作系统用于内存与硬盘之间进行数据交换的子系统。文件系统的系统结构由引导块（boot block）、超级块（super block）、索引节点块（inode list）、数据块（data block).</p><table><thead><tr><th>块区</th><th>作用</th></tr></thead><tbody><tr><td>引导块</td><td>操作系统初始化执行的程序</td></tr><tr><td>超级块</td><td>描述文件系统信息，如：多大、哪里由空闲块</td></tr><tr><td>索引节点表</td><td>记录索引节点</td></tr><tr><td>数据块</td><td>真正用于存储数据的地方</td></tr></tbody></table><p><img src="https://note-image-1302477034.cos.ap-chengdu.myqcloud.com/pic/202210081019885.png" alt=""></p><p>文件系统中还包含一系列的算法，下面是较底层的文件系统算法。 <img src="https://note-image-1302477034.cos.ap-chengdu.myqcloud.com/pic/202210092003281.png" alt=""></p><h1 id="_2-索引节点" tabindex="-1">2 索引节点 <a class="header-anchor" href="#_2-索引节点" aria-hidden="true">#</a></h1><p>索引节点是记录文件信息的<strong>数据结构</strong>，记录的信息有文件大小、文件在磁盘上的存储布局等。文件系统根据索引节点的信息将磁盘内的数据读到高速缓冲，以供进程的使用。需要注意的是：改变一个文件的内容自动地暗示着其索引节点的改变，但改变索引节点并不意味着文件内容的改变。例如：图2-1列出来索引节点包含的信息。 <img src="https://note-image-1302477034.cos.ap-chengdu.myqcloud.com/pic/202210092034657.png" alt="图2-1"></p><p>内核要操作索引节点需要将其从硬盘中读取进入内存，而内存中的索引节点与磁盘中不同，加入了一些字段，以实现内核对索引节点的操作。这些字段和缓冲区的有些类似，因为它们的<strong>维护方式</strong>类似，可以结合起来记忆。</p><table><thead><tr><th>字段</th><th>作用</th></tr></thead><tbody><tr><td>状态</td><td>锁...</td></tr><tr><td>逻辑设备号（文件系统）</td><td>表示文件所在的逻辑设备</td></tr><tr><td>索引节点号</td><td>索引节点存储在磁盘中的线性数组，节点从内存到磁盘中时需要</td></tr><tr><td>指向其它索引节点的指针</td><td>维护索引节点</td></tr><tr><td>引用数</td><td>有多少个进程使用到了它</td></tr><tr><td>需要记住最重要的一点：</td><td></td></tr></tbody></table><ul><li>仅当索引节点的引用计数为0时，才位于空闲表上，以表示内核能把这个内存索引节点重新分配给另一个磁盘索引节点。</li></ul><h2 id="_2-1-索引节点的存取" tabindex="-1">2.1 索引节点的存取 <a class="header-anchor" href="#_2-1-索引节点的存取" aria-hidden="true">#</a></h2><ol><li>系统如何得知需要的索引节点号？？</li></ol><h3 id="_2-1-1-iget算法" tabindex="-1">2.1.1 iget算法 <a class="header-anchor" href="#_2-1-1-iget算法" aria-hidden="true">#</a></h3><p>iget算法使用获取索引节点，当索引节点已经在内存中时，检查索引节点状态，若无锁，然后检查是否在空闲表上，即是否空闲，若空闲则将其移除空闲表，然后引用计数+1，返回索引节点。若有锁，则睡眠等待被唤醒。若不在内存中，会尝试分配一个空闲的索引节点（引用计数为0)，若空闲表为空，则直接返回错误，这里与缓冲区睡眠不同，因为内核不能保证未来一定能够分配给进程索引节点。索引节点是否在空闲表中是由引用计数控制的，恶意程序可以永远保持计数不为0，即可以在用户级对其控制。因此，出于安全，直接返回错误。 这里的操作我们可以看出内核<strong>独立</strong>地操控索引节点锁和引用计数。可以理解为<strong>无锁不意味着在空闲表内</strong>。这与缓冲区无锁意味着在空闲表不同。</p><div class="language-c"><button class="copy"></button><span class="lang">c</span><pre><code><span class="line"><span style="color:#A6ACCD;">算法 iget</span></span>
<span class="line"><span style="color:#A6ACCD;">输入：文件系统的索引节点号</span></span>
<span class="line"><span style="color:#A6ACCD;">输出：上锁状态的索引节点</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">while</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">未完成</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">if</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">是索引节点高速缓冲中的索引节点</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#89DDFF;">if</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">索引节点为上锁状态</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">                设置内存索引节点的标志，以指示正在等待其变为空闲</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">                </span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">索引节点变为开锁状态事件</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">                </span><span style="color:#89DDFF;">continue</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;">// 对安装点进行特殊处理,后面会说</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#89DDFF;">if</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">是空闲索引节点表上的索引节点</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">                从空闲表上移走节点</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">            索引节点引用计数 </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">索引节点</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">if</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">空闲表上没有索引节点</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">错误</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span></span>
<span class="line"><span style="color:#F07178;">        从空闲表上移走一个新的索引节点</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">        重置索引节点号和文件系统号</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">        将该索引节点从旧队列移动到新队列</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">        从磁盘上读取索引节点</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">算法bread</span><span style="color:#89DDFF;">);</span><span style="color:#676E95;"> // bread的参数需要文件系统块号</span></span>
<span class="line"><span style="color:#F07178;">        索引节点初始化（例如引用计数置为1、各类信息的拷贝)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">索引节点</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>经过类似缓冲区获取的操作，iget中调用了bread，而bread需要文件系统块号。因此，需要通过索引节点号来计算出对应的块号。 $$ ((inode \ num - 1 ) / num \ of \ inodes \ per \ block) + start \ block \ of \ inode \ list. $$ 例如：索引节点表从第2块开始并且每块有8个索引节点，则第8号索引节点在第2磁盘块中，第9号索引节点在第3磁盘块中。</p><p>前面获得块，还需要从块中得到节点。因此需要使用计算出索引节点的字节偏移量。 $$ （（inode \ num - 1 ) \ mod \ (num \ of \ inodes \ per \ block) * disk \ inode \ size $$ 最后，将硬盘（缓冲区）中的索引节点拷贝到内存中的索引节点，然后进行初始化操作，如引用计数为1等。最终，返回一个上锁的索引节点。</p><h3 id="_2-1-2-释放索引节点" tabindex="-1">2.1.2 释放索引节点 <a class="header-anchor" href="#_2-1-2-释放索引节点" aria-hidden="true">#</a></h3><div class="language-c"><button class="copy"></button><span class="lang">c</span><pre><code><span class="line"><span style="color:#A6ACCD;">算法 iput</span><span style="color:#676E95;"> // 释放对内存索引节点的存取</span></span>
<span class="line"><span style="color:#A6ACCD;">输入：指向内存索引节点的指针</span></span>
<span class="line"><span style="color:#A6ACCD;">输出：无</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    如果索引节点未上锁，则将其上锁</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    将索引节点引用计数 </span><span style="color:#89DDFF;">-</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">if</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">访问计数为0</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">if</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">索引节点联结计数为0</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">            释放文件所占的磁盘块</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">算法free</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">            将文件类型置为0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">            释放索引节点</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">算法ifree</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">if</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">文件被存取或索引节点被改变或文件被改变</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">            修改磁盘索引节点</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">        将索引节点放到空闲表</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    为索引节点解锁</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h1 id="_3-正规文件结构" tabindex="-1">3 正规文件结构 <a class="header-anchor" href="#_3-正规文件结构" aria-hidden="true">#</a></h1><p>索引节点的<strong>磁盘明细表</strong>内包含着文件数据在磁盘上如何分布的，实际上明细表就是，磁盘块号的集合。这会产生一个问题，如果一个逻辑块包含1K字节，那么，由10K个字节组成的文件就需要10个块号的索引，由100K个字节组成的文件就需要100个块号的索引。索引节点大小会随着文件的大小而发生改变。这显然会增加系统的复杂度。（内存中也会出现类似的问题） 为了能够保持索引节点较小的结构而能组织大文件，使用了<strong>多级表</strong>的结构。 <img src="https://note-image-1302477034.cos.ap-chengdu.myqcloud.com/pic/202210101007957.png" alt=""> 前十个地址表表项直接指向了有实际数据的磁盘块。后三个表项会首先指向存储着指向实际数据磁盘块的磁盘块。通过这种结构，很容易将明细表组织的文件数据扩大。实际计算验证一下。 假设前提：</p><ul><li>逻辑块容量1KB</li><li>块号用32位（4B）编址，容易推算出一个逻辑块可以容纳256个块号</li><li>文件大小32位，可表示最大4GB大小文件 <img src="https://note-image-1302477034.cos.ap-chengdu.myqcloud.com/pic/202210101022782.png" alt=""> 16GB + 64MB + ... &gt; 4GB完全可以表示。</li></ul><h2 id="bmap算法" tabindex="-1">bmap算法 <a class="header-anchor" href="#bmap算法" aria-hidden="true">#</a></h2><p>bmap算法是将进程读取时所用的字节偏移量转化为对应物流磁盘块的算法。</p><div class="language-c"><button class="copy"></button><span class="lang">c</span><pre><code><span class="line"><span style="color:#A6ACCD;">算法 bmap</span><span style="color:#676E95;"> // 从逻辑文件字节偏移量到文件系统块的映射。</span></span>
<span class="line"><span style="color:#A6ACCD;">输入：</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> 索引节点 </span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">字节偏移量</span></span>
<span class="line"><span style="color:#A6ACCD;">输出：</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> 文件系统中的块号 </span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">块中的字节偏移量 </span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">块中IO字节数 </span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">提前读块号</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">   由字节偏移量计算出在文件中的逻辑块号</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">   为IO计算出块中的起始字符</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">   计算出拷贝给用户的字节数</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">   检查是否可用提前读并标记索引节点号</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">   决定间接级</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#89DDFF;">while</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">没有所必须得到间接级上</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       从文件中的逻辑块号计算索引节点中或间接块中的下标</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       从索引节点或间接块上得到磁盘块号</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       如果需要，应从先前的磁盘读释放缓冲区（算法brelse)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#89DDFF;">if</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">再也没有间接级了</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">           </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">块号</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">       读间接磁盘块</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">算法bread</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">       按照间接级调整文件中的逻辑块号</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div></div></div></main><!--[--><!--]--><footer class="VPDocFooter" data-v-37ebe389 data-v-a54a85bd><!----><div class="prev-next" data-v-a54a85bd><div class="pager" data-v-a54a85bd><a class="pager-link prev" href="/note/Unix/%E6%95%B0%E6%8D%AE%E7%BC%93%E5%86%B2%E5%8C%BA.html" data-v-a54a85bd><span class="desc" data-v-a54a85bd>Previous page</span><span class="title" data-v-a54a85bd>数据缓冲区</span></a></div><div class="has-prev pager" data-v-a54a85bd><!----></div></div></footer><!--[--><!--]--></div></div></div></div></div><footer class="VPFooter has-sidebar" data-v-c6a644e1 data-v-9f24cc86><div class="container" data-v-9f24cc86><p class="message" data-v-9f24cc86>Released under the MIT License.</p><p class="copyright" data-v-9f24cc86>Copyright © 2019-present Evan You</p></div></footer><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"how-to-read_index.md\":\"80ea7abd\",\"how-to-read_readlist.md\":\"befd0b49\",\"unix_index.md\":\"584853b7\",\"unix_数据缓冲区.md\":\"fa45b0bd\",\"unix_文件的内部表示.md\":\"f025079b\",\"doc_index.md\":\"a5af3f44\",\"doc_obsidian-seseimage.md\":\"136ff97a\",\"doc_xgplayer.md\":\"ccaae490\",\"index.md\":\"c9f98061\",\"rnote_index.md\":\"a07d0d93\"}")</script>
    <script type="module" async src="/note/assets/app.e06fd376.js"></script>
    
  </body>
</html>